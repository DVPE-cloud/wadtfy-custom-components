# Crossplane Composition linking the XRD with the concrete managed EFS Network resource.
# See https://negz.github.io/crossplane.github.io/docs/v1.4/reference/composition.html#compositions for details

apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: tenant-filesystem
spec:
  writeConnectionSecretsToNamespace: crossplane-system
  environment:
    environmentConfigs:
      - ref:
          name: wadtfy-env
  compositeTypeRef:
    apiVersion: wadtfy.bmwgroup.net/v1beta1
    kind: XTenantFilesystem
  patchSets:
    - name: "metadata"
      patches:
        - type: CombineFromComposite
          combine:
            variables:
              - fromFieldPath: "spec.product"
              - fromFieldPath: "metadata.labels[crossplane.io/claim-namespace]"
              - fromFieldPath: "metadata.labels[crossplane.io/claim-name]"
            strategy: string
            string:
              fmt: "tenant-filesystem-%s-%s-%s"
          toFieldPath: "metadata.name"
    - name: "tags"
      patches:
        # - fromFieldPath: "spec.product"
        #   transforms:
        #     - type: string
        #       string:
        #         fmt: "XTenantFileSystem"
        #   toFieldPath: "spec.forProvider.tags[0].tagValue"
        # - fromFieldPath: "spec.product"
        #   transforms:
        #     - type: string
        #       string:
        #         fmt: "v1alpha1"
        #   toFieldPath: "spec.forProvider.tags[1].tagValue"
        - fromFieldPath: "metadata.name"
          toFieldPath: "spec.forProvider.tags[2].tagValue"
        - type: FromEnvironmentFieldPath
          fromFieldPath: "eksAccountID"
          toFieldPath: "spec.forProvider.tags[3].tagValue"
          transforms:
            - type: convert
              convert:
                toType: string
        - fromFieldPath: "spec.product"
          toFieldPath: "spec.forProvider.tags[4].tagValue"

    - name: "tagsV2"
      patches:
        # - fromFieldPath: "spec.product"
        #   transforms:
        #     - type: string
        #       string:
        #         fmt: "XTenantFileSystem"
        #   toFieldPath: "spec.forProvider.tags[0].value"
        # - fromFieldPath: "spec.product"
        #   transforms:
        #     - type: string
        #       string:
        #         fmt: "v1alpha1"
        #   toFieldPath: "spec.forProvider.tags[1].value"
        - fromFieldPath: "metadata.name"
          toFieldPath: "spec.forProvider.tags[2].value"
        - type: FromEnvironmentFieldPath
          fromFieldPath: "eksAccountID"
          toFieldPath: "spec.forProvider.tags[3].value"
          transforms:
            - type: convert
              convert:
                toType: string
        - fromFieldPath: "spec.product"
          toFieldPath: "spec.forProvider.tags[4].value"
    - name: "providerConfigRef"
      patches:
        - fromFieldPath: "spec.providerConfig"
          toFieldPath: "spec.providerConfigRef.name"
          policy:
            fromFieldPath: Required

  resources:
    - name: tenant-kms-key
      base:
        apiVersion: kms.aws.crossplane.io/v1alpha1
        kind: Key
        metadata:
          labels:
            crossplane/xrd-kind: xtenantfilesystem.wadtfy.bmwgroup.net
            crossplane/xrd-helm_chart_version: {{ .Chart.Version }}
        spec:
          deletionPolicy: Delete
          forProvider:
            tags:
              - tagKey: "wadtfy.bmwgroup.net/xrd-type"
                tagValue: "XTenantFileSystem"
              - tagKey: "wadtfy.bmwgroup.net/xrd-version"
                tagValue: "v1alpha1"
              - tagKey: "wadtfy.bmwgroup.net/component-name"
                tagValue: ""
              - tagKey: "wadtfy.bmwgroup.net/cluster-account-id"
                tagValue: ""
              - tagKey: "wadtfy.bmwgroup.net/product-name"
                tagValue: ""
            enableKeyRotation: true
            enabled: true
            policy: ""
            region: ""
          providerConfigRef:
            name: ""
      patches:
        - type: PatchSet
          patchSetName: "metadata"
        - type: PatchSet
          patchSetName: "providerConfigRef"
        - type: PatchSet
          patchSetName: "tags"
        - fromFieldPath: "spec.deletePolicy"
          toFieldPath: "spec.deletePolicy"
        - fromFieldPath: "spec.region"
          toFieldPath: "spec.forProvider.region"
          policy:
            fromFieldPath: Required
        - fromFieldPath: "spec.accountID"
          toFieldPath: "spec.forProvider.policy"
          transforms:
            - type: string
              string:
                fmt: |
                  {
                    "Version": "2012-10-17",
                    "Id": "key-policy",
                    "Statement": [
                      {
                        "Sid": "Enable IAM User Permissions",
                        "Effect": "Allow",
                        "Principal": {
                          "AWS": "arn:aws:iam::%s:root"
                        },
                        "Action": "kms:*",
                        "Resource": "*"
                      }
                    ]
                  }
        - type: ToCompositeFieldPath
          fromFieldPath: "metadata.name"
          toFieldPath: "status.kmsKeyRefName"

    - name: tenant-elasticfilesystem
      base:
        apiVersion: efs.aws.crossplane.io/v1alpha1
        kind: FileSystem
        metadata:
          labels:
            crossplane/xrd-kind: xtenantfilesystem.wadtfy.bmwgroup.net
            crossplane/xrd-helm_chart_version: {{ .Chart.Version }}
        spec:
          deletionPolicy: Delete
          forProvider:
            tags:
              - key: "wadtfy.bmwgroup.net/xrd-type"
                value: "XTenantFileSystem"
              - key: "wadtfy.bmwgroup.net/xrd-version"
                value: "v1alpha1"
              - key: "wadtfy.bmwgroup.net/component-name"
                value: ""
              - key: "wadtfy.bmwgroup.net/cluster-account-id"
                value: ""
              - key: "wadtfy.bmwgroup.net/product-name"
                value: ""
            encrypted: true
            kmsKeyIdRef:
              name: ""
            performanceMode: ""
            throughputMode: ""
            region: ""
          providerConfigRef:
            name: ""
      patches:
        - type: PatchSet
          patchSetName: "metadata"
        - type: PatchSet
          patchSetName: "providerConfigRef"
        - type: PatchSet
          patchSetName: "tagsV2"
        - fromFieldPath: "spec.deletePolicy"
          toFieldPath: "spec.deletePolicy"
        - fromFieldPath: "status.kmsKeyRefName"
          toFieldPath: "spec.forProvider.kmsKeyIdRef.name"
          policy:
            fromFieldPath: Required
        - fromFieldPath: "spec.efsPerformanceMode"
          toFieldPath: "spec.forProvider.performanceMode"
          policy:
            fromFieldPath: Required
        - fromFieldPath: "spec.efsThroughputMode"
          toFieldPath: "spec.forProvider.throughputMode"
          policy:
            fromFieldPath: Required
        - fromFieldPath: "spec.region"
          toFieldPath: "spec.forProvider.region"
          policy:
            fromFieldPath: Required
        - type: ToCompositeFieldPath
          fromFieldPath: "metadata.name"
          toFieldPath: "status.fileSystemRef"
        - type: ToCompositeFieldPath
          fromFieldPath: "status.atProvider.fileSystemID"
          toFieldPath: "status.fileSystemID"

    - name: tenant-iam-role
      base:
        apiVersion: iam.aws.crossplane.io/v1beta1
        kind: Role
        metadata:
          labels:
            crossplane/xrd-kind: xtenantfilesystem.wadtfy.bmwgroup.net
            crossplane/xrd-helm_chart_version: {{ .Chart.Version }}
        spec:
          deletionPolicy: Delete
          forProvider:
            tags:
              - key: "wadtfy.bmwgroup.net/xrd-type"
                value: "XTenantFileSystem"
              - key: "wadtfy.bmwgroup.net/xrd-version"
                value: "v1alpha1"
              - key: "wadtfy.bmwgroup.net/component-name"
                value: ""
              - key: "wadtfy.bmwgroup.net/cluster-account-id"
                value: ""
              - key: "wadtfy.bmwgroup.net/product-name"
                value: ""
            assumeRolePolicyDocument: ""
            description: IAM Trust Role
          providerConfigRef:
            name: ""
      patches:
        - type: PatchSet
          patchSetName: "metadata"
        - type: PatchSet
          patchSetName: "providerConfigRef"
        - type: PatchSet
          patchSetName: "tagsV2"
        - fromFieldPath: "spec.deletePolicy"
          toFieldPath: "spec.deletePolicy"
        - type: ToCompositeFieldPath
          fromFieldPath: "metadata.name"
          toFieldPath: "status.roleName"
        - type: FromEnvironmentFieldPath
          fromFieldPath: "eksAccountID"
          toFieldPath: "spec.forProvider.assumeRolePolicyDocument"
          transforms:
            - type: convert
              convert:
                toType: string
            - type: string
              string:
                fmt: |
                  {
                    "Version": "2012-10-17",
                    "Statement": [
                      {
                        "Effect": "Allow",
                        "Principal": {
                          "AWS": "arn:aws:iam::%s:root"
                        },
                        "Action": "sts:AssumeRole",
                        "Condition": {}
                      }
                    ]
                  }

    - name: tenant-policy
      base:
        apiVersion: iam.aws.crossplane.io/v1beta1
        kind: Policy
        metadata:
          labels:
            crossplane/xrd-kind: xtenantfilesystem.wadtfy.bmwgroup.net
            crossplane/xrd-helm_chart_version: {{ .Chart.Version }}
        spec:
          deletionPolicy: Delete
          forProvider:
            tags:
              - key: "wadtfy.bmwgroup.net/xrd-type"
                value: "XTenantFileSystem"
              - key: "wadtfy.bmwgroup.net/xrd-version"
                value: "v1alpha1"
              - key: "wadtfy.bmwgroup.net/component-name"
                value: ""
              - key: "wadtfy.bmwgroup.net/cluster-account-id"
                value: ""
              - key: "wadtfy.bmwgroup.net/product-name"
                value: ""
            document: ""
            name:
          providerConfigRef:
            name: ""
      patches:
        - type: PatchSet
          patchSetName: "providerConfigRef"
        - type: PatchSet
          patchSetName: "tagsV2"
        - type: CombineFromComposite
          combine:
            variables:
              - fromFieldPath: "spec.product"
              - fromFieldPath: "metadata.labels[crossplane.io/claim-namespace]"
              - fromFieldPath: "metadata.labels[crossplane.io/claim-name]"
            strategy: string
            string:
              fmt: "tenant-filesystem-%s-%s-%s-remote"
          toFieldPath: "metadata.name"
        - fromFieldPath: "spec.deletePolicy"
          toFieldPath: "spec.deletePolicy"
        - fromFieldPath: "metadata.name"
          toFieldPath: "spec.forProvider.name"
          transforms:
            - type: string
              string:
                fmt: "%s-EFSDescribeMountTargetIAMPolicy"
          policy:
            fromFieldPath: Required
        - type: CombineFromComposite
          combine:
            variables:
              - fromFieldPath: "spec.region"
              - fromFieldPath: "spec.accountID"
              - fromFieldPath: "status.fileSystemID"
            strategy: string
            string:
              fmt: |
                {
                  "Version": "2012-10-17",
                  "Statement": [
                    {
                      "Sid" : "Stmt1DescribeMountTargets",
                      "Effect": "Allow",
                      "Action": [
                        "elasticfilesystem:DescribeFileSystems",
                        "elasticfilesystem:DescribeMountTargets",
                        "elasticfilesystem:CreateAccessPoint"
                      ],
                      "Resource": "arn:aws:elasticfilesystem:%s:%s:file-system/%s"
                    },
                    {
                      "Sid" : "Stmt2AdditionalEC2PermissionsToDescribeMountTarget",
                      "Effect": "Allow",
                      "Action": [
                        "ec2:DescribeSubnets",
                        "ec2:DescribeNetworkInterfaces"
                      ],
                      "Resource": "*"
                    }
                  ]
                }
          toFieldPath: "spec.forProvider.document"
          policy:
            fromFieldPath: Required
        - type: ToCompositeFieldPath
          fromFieldPath: "metadata.name"
          toFieldPath: "status.policyNameRemote"

    - name: tenant-role-policy-attach
      base:
        apiVersion: iam.aws.crossplane.io/v1beta1
        kind: RolePolicyAttachment
        metadata:
          labels:
            crossplane/xrd-kind: xtenantfilesystem.wadtfy.bmwgroup.net
            crossplane/xrd-helm_chart_version: {{ .Chart.Version }}
        spec:
          deletionPolicy: Delete
          forProvider:
            policyArnRef:
              name: ""
            roleNameRef:
              name: ""
          providerConfigRef:
            name: ""
      patches:
        - type: CombineFromComposite
          combine:
            variables:
              - fromFieldPath: "spec.product"
              - fromFieldPath: "metadata.labels[crossplane.io/claim-namespace]"
              - fromFieldPath: "metadata.labels[crossplane.io/claim-name]"
            strategy: string
            string:
              fmt: "tenant-filesystem-%s-%s-%s-remote"
          toFieldPath: "metadata.name"
        - type: PatchSet
          patchSetName: "providerConfigRef"
        - fromFieldPath: "spec.deletePolicy"
          toFieldPath: "spec.deletePolicy"
        - fromFieldPath: "status.roleName"
          toFieldPath: "spec.forProvider.roleNameRef.name"
          policy:
            fromFieldPath: Required
        - fromFieldPath: "status.policyNameRemote"
          toFieldPath: "spec.forProvider.policyArnRef.name"
          policy:
            fromFieldPath: Required
        # no tags available in RolePolicyAttachment CRD

    - name: tenant-efs-securitygroup
      base:
        apiVersion: ec2.aws.crossplane.io/v1beta1
        kind: SecurityGroup
        metadata:
          labels:
            crossplane/xrd-kind: xtenantfilesystem.wadtfy.bmwgroup.net
            crossplane/xrd-helm_chart_version: {{ .Chart.Version }}
        spec:
          deletionPolicy: Delete
          forProvider:
            tags:
              - key: "wadtfy.bmwgroup.net/xrd-type"
                value: "XTenantFileSystem"
              - key: "wadtfy.bmwgroup.net/xrd-version"
                value: "v1alpha1"
              - key: "wadtfy.bmwgroup.net/component-name"
                value: ""
              - key: "wadtfy.bmwgroup.net/cluster-account-id"
                value: ""
              - key: "wadtfy.bmwgroup.net/product-name"
                value: ""
            description: Tenant StorageClass for EFS
            groupName: ""
            ingress:
            - fromPort: 2049
              ipProtocol: tcp
              ipRanges:
              - cidrIp: ""
              toPort: 2049
            region: ""
            vpcId: ""
          providerConfigRef:
            name: ""
      patches:
        - type: PatchSet
          patchSetName: "metadata"
        - type: PatchSet
          patchSetName: "providerConfigRef"
        - type: PatchSet
          patchSetName: "tagsV2"
        - fromFieldPath: "spec.deletePolicy"
          toFieldPath: "spec.deletePolicy"
        - type: FromEnvironmentFieldPath
          fromFieldPath: "eksCidrIp"
          toFieldPath: "spec.forProvider.ingress[0].ipRanges[0].cidrIp"
          policy:
            fromFieldPath: Required
        - fromFieldPath: "spec.region"
          toFieldPath: "spec.forProvider.region"
          policy:
            fromFieldPath: Required
        - fromFieldPath: "spec.vpcId"
          toFieldPath: "spec.forProvider.vpcId"
          policy:
            fromFieldPath: Required
        - fromFieldPath: "metadata.name"
          toFieldPath: "spec.forProvider.groupName"
          transforms:
            - type: string
              string:
                fmt: "%s-sg-efs"
        - type: ToCompositeFieldPath
          fromFieldPath: "metadata.name"
          toFieldPath: "status.securityGroupName"

    - name: tenant-efs-mounttarget-1
      base:
        apiVersion: efs.aws.crossplane.io/v1alpha1
        kind: MountTarget
        metadata:
          labels:
            crossplane/xrd-kind: xtenantfilesystem.wadtfy.bmwgroup.net
            crossplane/xrd-helm_chart_version: {{ .Chart.Version }}
        spec:
          forProvider:
            fileSystemIDRef:
              name: ""
            region: ""
            securityGroupsRefs:
              - name: ""
            subnetID: ""
          providerConfigRef:
            name: ""
      patches:
        - type: PatchSet
          patchSetName: "providerConfigRef"
        - type: CombineFromComposite
          combine:
            variables:
              - fromFieldPath: "spec.product"
              - fromFieldPath: "metadata.labels[crossplane.io/claim-namespace]"
              - fromFieldPath: "metadata.labels[crossplane.io/claim-name]"
            strategy: string
            string:
              fmt: "tenant-filesystem-%s-%s-%s-1"
          toFieldPath: "metadata.name"
        - fromFieldPath: "spec.region"
          toFieldPath: "spec.forProvider.region"
          policy:
            fromFieldPath: Required
        - fromFieldPath: "status.fileSystemRef"
          toFieldPath: "spec.forProvider.fileSystemIDRef.name"
          policy:
            fromFieldPath: Required
        - fromFieldPath: "status.securityGroupName"
          toFieldPath: "spec.forProvider.securityGroupsRefs[0].name"
          policy:
            fromFieldPath: Required
        - fromFieldPath: "spec.vpcSubnetIdA"
          toFieldPath: "spec.forProvider.subnetID"
          policy:
            fromFieldPath: Required

    - name: tenant-efs-mounttarget-2
      base:
        apiVersion: efs.aws.crossplane.io/v1alpha1
        kind: MountTarget
        metadata:
          labels:
            crossplane/xrd-kind: xtenantfilesystem.wadtfy.bmwgroup.net
            crossplane/xrd-helm_chart_version: {{ .Chart.Version }}
        spec:
          forProvider:
            fileSystemIDRef:
              name: ""
            region: ""
            securityGroupsRefs:
              - name: ""
            subnetID: ""
          providerConfigRef:
            name: ""
      patches:
        - type: PatchSet
          patchSetName: "providerConfigRef"
        - type: CombineFromComposite
          combine:
            variables:
              - fromFieldPath: "spec.product"
              - fromFieldPath: "metadata.labels[crossplane.io/claim-namespace]"
              - fromFieldPath: "metadata.labels[crossplane.io/claim-name]"
            strategy: string
            string:
              fmt: "tenant-filesystem-%s-%s-%s-2"
          toFieldPath: "metadata.name"
        - fromFieldPath: "spec.region"
          toFieldPath: "spec.forProvider.region"
          policy:
            fromFieldPath: Required
        - fromFieldPath: "status.fileSystemRef"
          toFieldPath: "spec.forProvider.fileSystemIDRef.name"
          policy:
            fromFieldPath: Required
        - fromFieldPath: "status.securityGroupName"
          toFieldPath: "spec.forProvider.securityGroupsRefs[0].name"
          policy:
            fromFieldPath: Required
        - fromFieldPath: "spec.vpcSubnetIdB"
          toFieldPath: "spec.forProvider.subnetID"
          policy:
            fromFieldPath: Required

    - name: tenant-efs-mounttarget-3
      base:
        apiVersion: efs.aws.crossplane.io/v1alpha1
        kind: MountTarget
        metadata:
          labels:
            crossplane/xrd-kind: xtenantfilesystem.wadtfy.bmwgroup.net
            crossplane/xrd-helm_chart_version: {{ .Chart.Version }}
        spec:
          forProvider:
            fileSystemIDRef:
              name: ""
            region: ""
            securityGroupsRefs:
              - name: ""
            subnetID: ""
          providerConfigRef:
            name: ""
      patches:
        - type: PatchSet
          patchSetName: "providerConfigRef"
        - type: CombineFromComposite
          combine:
            variables:
              - fromFieldPath: "spec.product"
              - fromFieldPath: "metadata.labels[crossplane.io/claim-namespace]"
              - fromFieldPath: "metadata.labels[crossplane.io/claim-name]"
            strategy: string
            string:
              fmt: "tenant-filesystem-%s-%s-%s-3"
          toFieldPath: "metadata.name"
        - fromFieldPath: "spec.region"
          toFieldPath: "spec.forProvider.region"
          policy:
            fromFieldPath: Required
        - fromFieldPath: "status.fileSystemRef"
          toFieldPath: "spec.forProvider.fileSystemIDRef.name"
          policy:
            fromFieldPath: Required
        - fromFieldPath: "status.securityGroupName"
          toFieldPath: "spec.forProvider.securityGroupsRefs[0].name"
          policy:
            fromFieldPath: Required
        - fromFieldPath: "spec.vpcSubnetIdC"
          toFieldPath: "spec.forProvider.subnetID"
          policy:
            fromFieldPath: Required

    - name: local-csi-policy
      base:
        apiVersion: iam.aws.crossplane.io/v1beta1
        kind: Policy
        metadata:
          labels:
            crossplane/xrd-kind: xtenantfilesystem.wadtfy.bmwgroup.net
            crossplane/xrd-helm_chart_version: {{ .Chart.Version }}
        spec:
          deletionPolicy: Delete
          forProvider:
            tags:
              - key: "wadtfy.bmwgroup.net/xrd-type"
                value: "XTenantFileSystem"
              - key: "wadtfy.bmwgroup.net/xrd-version"
                value: "v1alpha1"
              - key: "wadtfy.bmwgroup.net/component-name"
                value: ""
              - key: "wadtfy.bmwgroup.net/cluster-account-id"
                value: ""
              - key: "wadtfy.bmwgroup.net/product-name"
                value: ""
            document: ""
            description: IAM Assume Role
            name: ""
          providerConfigRef:
            name: provider-config-aws
      patches:
        - type: PatchSet
          patchSetName: "tagsV2"
        - type: CombineFromComposite
          combine:
            variables:
              - fromFieldPath: "spec.product"
              - fromFieldPath: "metadata.labels[crossplane.io/claim-namespace]"
              - fromFieldPath: "metadata.labels[crossplane.io/claim-name]"
            strategy: string
            string:
              fmt: "tenant-filesystem-%s-%s-%s-local"
          toFieldPath: "metadata.name"
        - fromFieldPath: "metadata.name"
          toFieldPath: "spec.forProvider.name"
        - fromFieldPath: "spec.deletePolicy"
          toFieldPath: "spec.deletePolicy"
        - type: CombineFromComposite
          combine:
            variables:
              - fromFieldPath: "spec.accountID"
              - fromFieldPath: "status.roleName"
            strategy: string
            string:
              fmt: |
                {
                  "Version": "2012-10-17",
                  "Statement": {
                    "Effect": "Allow",
                    "Action": "sts:AssumeRole",
                    "Resource": "arn:aws:iam::%s:role/%s"
                  }
                }
          toFieldPath: "spec.forProvider.document"
          policy:
            fromFieldPath: Required
        - type: ToCompositeFieldPath
          fromFieldPath: "metadata.name"
          toFieldPath: "status.policyNameLocal"

    - name: local-csi-controller-policy-attach
      base:
        apiVersion: iam.aws.crossplane.io/v1beta1
        kind: RolePolicyAttachment
        metadata:
          name:
          labels:
            crossplane/xrd-kind: xtenantfilesystem.wadtfy.bmwgroup.net
            crossplane/xrd-helm_chart_version: {{ .Chart.Version }}
        spec:
          deletionPolicy: Delete
          forProvider:
            policyArnRef:
              name: ""
            roleName:
          providerConfigRef:
            name: provider-config-aws
      patches:
        - type: CombineFromComposite
          combine:
            variables:
              - fromFieldPath: "spec.product"
              - fromFieldPath: "metadata.labels[crossplane.io/claim-namespace]"
              - fromFieldPath: "metadata.labels[crossplane.io/claim-name]"
            strategy: string
            string:
              fmt: "tenant-filesystem-%s-%s-%s-csicontroller"
          toFieldPath: "metadata.name"
        - fromFieldPath: "spec.deletePolicy"
          toFieldPath: "spec.deletePolicy"
        - fromFieldPath: "status.policyNameLocal"
          toFieldPath: "spec.forProvider.policyArnRef.name"
          policy:
            fromFieldPath: Required
        - type: FromEnvironmentFieldPath
          fromFieldPath: "eksCsiDriverControllerSaRoleName"
          toFieldPath: "spec.forProvider.roleName"
          policy:
            fromFieldPath: Required

    - name: local-csi-node-policy-attach
      base:
        apiVersion: iam.aws.crossplane.io/v1beta1
        kind: RolePolicyAttachment
        metadata:
          name:
          labels:
            crossplane/xrd-kind: xtenantfilesystem.wadtfy.bmwgroup.net
            crossplane/xrd-helm_chart_version: {{ .Chart.Version }}
        spec:
          deletionPolicy: Delete
          forProvider:
            policyArn: arn:aws:iam::aws:policy/AmazonElasticFileSystemClientFullAccess
            roleName:
          providerConfigRef:
            name: provider-config-aws
      patches:
        - type: CombineFromComposite
          combine:
            variables:
              - fromFieldPath: "spec.product"
              - fromFieldPath: "metadata.labels[crossplane.io/claim-namespace]"
              - fromFieldPath: "metadata.labels[crossplane.io/claim-name]"
            strategy: string
            string:
              fmt: "tenant-filesystem-%s-%s-%s-csinode"
          toFieldPath: "metadata.name"
        - fromFieldPath: "spec.deletePolicy"
          toFieldPath: "spec.deletePolicy"
        - type: FromEnvironmentFieldPath
          fromFieldPath: "eksCsiDriverNodeSaRoleName"
          toFieldPath: "spec.forProvider.roleName"
          policy:
            fromFieldPath: Required

    - name: local-storageClass-secret
      base:
        apiVersion: kubernetes.crossplane.io/v1alpha1
        kind: Object
        metadata:
          labels:
            crossplane/xrd-kind: xtenantfilesystem.wadtfy.bmwgroup.net
            crossplane/xrd-helm_chart_version: {{ .Chart.Version }}
        spec:
          forProvider:
            manifest:
              apiVersion: v1
              kind: Secret
              metadata:
                name:
                namespace:
              type: Opaque
              data:
                awsRoleArn: ""
          providerConfigRef:
            name: provider-config-k8s
      patches:
        - type: PatchSet
          patchSetName: "metadata"
        - fromFieldPath: "metadata.labels[crossplane.io/claim-namespace]"
          toFieldPath: "spec.forProvider.manifest.metadata.namespace"
        - type: CombineFromComposite
          combine:
            variables:
              - fromFieldPath: "spec.accountID"
              - fromFieldPath: "status.roleName"
            strategy: string
            string:
              fmt: "arn:aws:iam::%s:role/%s"
          toFieldPath: "spec.forProvider.manifest.data.awsRoleArn"
          transforms:
            - type: string
              string:
                type: Convert
                convert: ToBase64
          policy:
            fromFieldPath: Required
        - type: ToCompositeFieldPath
          fromFieldPath: "metadata.name"
          toFieldPath: "status.storageClassSecret"

    - name: storageClass
      base:
        apiVersion: kubernetes.crossplane.io/v1alpha1
        kind: Object
        metadata:
          labels:
            crossplane/xrd-kind: xtenantfilesystem.wadtfy.bmwgroup.net
            crossplane/xrd-helm_chart_version: {{ .Chart.Version }}
        spec:
          forProvider:
            manifest:
              apiVersion: storage.k8s.io/v1
              kind: StorageClass
              metadata:
                name:
                annotations:
                  wadtfy.bmwgroup.net/restricted-namespaces: ""
              mountOptions:
              - tls
              - iam
              parameters:
                az: ""
                csi.storage.k8s.io/provisioner-secret-name: ""
                csi.storage.k8s.io/provisioner-secret-namespace: ""
                directoryPerms: "700"
                fileSystemId: ""
                provisioningMode: efs-ap
              provisioner: efs.csi.aws.com
              reclaimPolicy: Delete
              volumeBindingMode: Immediate
          providerConfigRef:
            name: provider-config-k8s
      patches:
        - type: PatchSet
          patchSetName: "metadata"
        - fromFieldPath: "metadata.labels[crossplane.io/claim-namespace]"
          toFieldPath: "spec.forProvider.manifest.metadata.annotations[wadtfy.bmwgroup.net/restricted-namespaces]"
        - fromFieldPath: "spec.region"
          toFieldPath: "spec.forProvider.manifest.parameters.az"
          policy:
            fromFieldPath: Required
        - fromFieldPath: "status.storageClassSecret"
          toFieldPath: "spec.forProvider.manifest.parameters[csi.storage.k8s.io/provisioner-secret-name]"
          policy:
            fromFieldPath: Required
        - fromFieldPath: "metadata.labels[crossplane.io/claim-namespace]"
          toFieldPath: "spec.forProvider.manifest.parameters[csi.storage.k8s.io/provisioner-secret-namespace]"
        - fromFieldPath: "status.fileSystemID"
          toFieldPath: "spec.forProvider.manifest.parameters.fileSystemId"
          policy:
            fromFieldPath: Required

    - name: Role
      base:
        apiVersion: kubernetes.crossplane.io/v1alpha1
        kind: Object
        metadata:
          labels:
            crossplane/xrd-kind: xtenantfilesystem.wadtfy.bmwgroup.net
            crossplane/xrd-helm_chart_version: {{ .Chart.Version }}
        spec:
          forProvider:
            manifest:
              apiVersion: rbac.authorization.k8s.io/v1
              kind: Role
              metadata:
                namespace:
              rules:
              - apiGroups:
                - ""
                resources:
                - secrets
                verbs:
                - get
                - list
          providerConfigRef:
            name: provider-config-k8s
      patches:
        - type: PatchSet
          patchSetName: "metadata"
        - fromFieldPath: "metadata.labels[crossplane.io/claim-namespace]"
          toFieldPath: "spec.forProvider.manifest.metadata.namespace"
        - type: ToCompositeFieldPath
          fromFieldPath: "metadata.name"
          toFieldPath: "status.rbacRoleName"

    - name: RoleBinding
      base:
        apiVersion: kubernetes.crossplane.io/v1alpha1
        kind: Object
        metadata:
          labels:
            crossplane/xrd-kind: xtenantfilesystem.wadtfy.bmwgroup.net
            crossplane/xrd-helm_chart_version: {{ .Chart.Version }}
        spec:
          forProvider:
            manifest:
              apiVersion: rbac.authorization.k8s.io/v1
              kind: RoleBinding
              metadata:
                namespace:
              roleRef:
                apiGroup: rbac.authorization.k8s.io
                kind: Role
                name:
              subjects:
              - kind: ServiceAccount
                name: kube-system-sa
                namespace: kube-system
          providerConfigRef:
            name: provider-config-k8s
      patches:
        - type: PatchSet
          patchSetName: "metadata"
        - fromFieldPath: "metadata.labels[crossplane.io/claim-namespace]"
          toFieldPath: "spec.forProvider.manifest.metadata.namespace"
        - fromFieldPath: "status.rbacRoleName"
          toFieldPath: "spec.forProvider.manifest.roleRef.name"
